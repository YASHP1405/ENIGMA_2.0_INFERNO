<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coding Test - MockMentor AI</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap");

        body {
            font-family: "Inter", sans-serif;
            background: #0f172a;
            color: white;
            overflow: hidden;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }
    </style>
</head>

<body class="h-[100dvh] flex flex-col relative">
    <canvas id="neuralCanvas" class="fixed top-0 left-0 w-full h-full -z-10"></canvas>

    <header class="glass h-14 flex-none flex items-center justify-between px-4 md:px-6 z-50">
        <div class="flex items-center gap-2 md:gap-3">
            <div class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse"></div>
            <span class="font-bold text-sm tracking-wide">Stage 2: Coding Assessment (<span
                    id="qCounter">1/2</span>)</span>
        </div>
        <div id="violationWarnings" class="flex items-center gap-2"></div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">

        <!-- LEFT: Question Prompts -->
        <section class="h-[30vh] md:h-full md:w-2/5 flex flex-col bg-slate-900/80 border-r border-white/10 z-20">
            <div class="p-6 flex-1 flex flex-col justify-center">
                <h2 class="text-2xl font-bold mb-4 text-cyan-400"><i data-lucide="code-2"
                        class="inline w-6 h-6 mr-2"></i> Problem Statement</h2>
                <div id="questionText"
                    class="text-xl leading-relaxed text-gray-200 bg-slate-800/50 p-6 rounded-xl border border-white/5 shadow-inner">
                    Loading Question...
                </div>

                <div id="aiStatus" class="mt-6 flex items-center gap-3 text-cyan-400 font-mono text-sm hidden">
                    <i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Analyzing Code via AI...
                </div>
            </div>
        </section>

        <!-- RIGHT: Code Editor -->
        <section class="flex-1 md:w-3/5 flex flex-col relative overflow-hidden bg-[#1e1e1e]">
            <div class="glass h-12 flex justify-between items-center px-4 border-b border-[#333]">
                <span class="text-xs text-gray-400 font-mono">solution.py</span>
                <button onclick="submitCode()" id="submitBtn"
                    class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-1.5 rounded text-xs font-bold transition flex items-center gap-2">
                    Submit Code <i data-lucide="play" class="w-3 h-3"></i>
                </button>
            </div>
            <div id="editor" class="flex-1 w-full h-full"></div>
        </section>

    </main>

    <script>
        if (window.lucide) window.lucide.createIcons();

        // Background Anim
        const canvas = document.getElementById("neuralCanvas");
        const ctx = canvas.getContext("2d");
        let width = canvas.width = window.innerWidth, height = canvas.height = window.innerHeight;
        class Particle {
            constructor() { this.reset(); }
            reset() { this.x = Math.random() * width; this.y = Math.random() * height; this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5; this.age = 0; this.life = 200; }
            update() { this.x += this.vx; this.y += this.vy; this.age++; if (this.age > this.life) this.reset(); }
            draw() { ctx.fillStyle = `rgba(6, 182, 212, ${0.3 * (1 - this.age / this.life)})`; ctx.fillRect(this.x, this.y, 2, 2); }
        }
        const particles = Array(100).fill().map(() => new Particle());
        function loop() { ctx.clearRect(0, 0, width, height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(loop); }
        loop();

        // Editor
        let editor = null;
        require.config({ paths: { vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs" } });
        require(["vs/editor/editor.main"], function () {
            editor = monaco.editor.create(document.getElementById("editor"), {
                value: "# Write your python solution here\n\n",
                language: "python",
                theme: "vs-dark",
                automaticLayout: true,
                minimap: { enabled: false },
                fontSize: 14,
                padding: { top: 16 }
            });
        });

        // Integrity Suite
        let violationCount = parseInt(localStorage.getItem('cognitive_violations') || 0);
        const maxViolations = 4;
        function registerViolation(reason) {
            violationCount++;
            localStorage.setItem('coding_violations', violationCount);
            const box = document.createElement("div");
            box.className = "bg-red-500/90 text-white text-xs font-bold px-3 py-1 rounded shadow-lg flex items-center gap-2";
            box.innerHTML = `<i data-lucide="alert-triangle" class="w-3 h-3"></i> ${reason} (${violationCount}/${maxViolations})`;
            document.getElementById("violationWarnings").appendChild(box);
            if (window.lucide) window.lucide.createIcons();
            setTimeout(() => box.remove(), 4000);
            if (violationCount >= maxViolations) {
                alert("ðŸš¨ Integrity Failure. Auto-submitting test.");
                window.location.href = "deep_report.html";
            }
        }

        document.addEventListener("visibilitychange", () => { if (document.hidden) registerViolation("Tab Switched"); });
        window.addEventListener("blur", () => registerViolation("Focus Lost"));

        const GROQ_API_KEY = "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";

        // Coding Flow
        const CODING_POOL = [
            { "question": "Write a python script to Print Hello World", "expected": "Hello World" },
            { "question": "Write a script to print the square of number 5", "expected": "25" }
        ];
        let codingIndex = 0;
        let codingScore = 0;

        function renderQuestion() {
            document.getElementById('questionText').innerText = CODING_POOL[codingIndex].question;
            document.getElementById('qCounter').innerText = `${codingIndex + 1}/${CODING_POOL.length}`;
            if (editor) editor.setValue("# Write your python solution here\n\n");
        }

        async function submitCode() {
            if (!editor) return;
            const code = editor.getValue();
            const expected = CODING_POOL[codingIndex].expected;
            const question = CODING_POOL[codingIndex].question;

            const prompt = `You are a Python code evaluator. 
      Problem: ${question}
      Expected Output context: ${expected}
      
      Candidate's Code:
      \`\`\`python
      ${code}
      \`\`\`
      
      Does the candidate's code logically accomplish the goal or print the expected output? Reply ONLY with "YES" or "NO". No markdown, no explanations.`;

            document.getElementById("aiStatus").classList.remove("hidden");
            document.getElementById("submitBtn").disabled = true;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${GROQ_API_KEY}` },
                    body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: [{ role: "user", content: prompt }], temperature: 0.1 })
                });
                const data = await res.json();
                const evalResult = data.choices[0].message.content.trim().toUpperCase();

                if (evalResult.includes("YES")) {
                    codingScore++;
                    alert("âœ… Correct!");
                } else {
                    alert(`âŒ Incorrect implementation.`);
                }
            } catch (e) {
                console.error("Eval Error:", e);
                // Fallback naive checking if API fails
                if (code.includes("print") && code.includes(expected.split(" ")[0])) codingScore++;
            }

            document.getElementById("aiStatus").classList.add("hidden");
            document.getElementById("submitBtn").disabled = false;

            codingIndex++;
            if (codingIndex >= CODING_POOL.length) {
                const finalScore = (codingScore / CODING_POOL.length) * 100;
                localStorage.setItem("coding_percent", finalScore);
                window.location.href = "deep_report.html";
            } else {
                renderQuestion();
            }
        }

        setTimeout(renderQuestion, 500); // Wait for DOM
    </script>
</body>

</html>